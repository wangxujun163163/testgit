function onDOMReady(){initOverlayApplyForm(),initOverlayApplyCode(),initOverlayApplyRight(),initOverlayApplyErr()}function initOverlayApplyForm(){updateOverlayAreaBrandSeries(current_brand_id,current_series_id);var a=$("#overlay_area"),b=$("#overlay_brand"),c=$("#overlay_series"),d=$("#overlay_name");d.focusin(function(a){d.removeClass("err").removeClass("right")}),d.focusout(function(a){var b=$.trim(d.val());b&&/^\S{1,12}$/.test(b)?d.addClass("right"):d.addClass("err")});var e=$("#overlay_mobile");e.focusin(function(a){e.removeClass("err").removeClass("right")}),e.focusout(function(a){var b=$.trim(e.val());b&&/^1\d{10}$/.test(b)?e.addClass("right"):e.addClass("err")});var f=$("#overlay_purchase");f.children("span.selector_item").on("click",function(a){var b=$(this);b.hasClass("selected")||(f.children("span.selector_item").removeClass("selected"),b.addClass("selected"))}),$("#overlay_btn").on("click",function(g){var h=$(this);if(!h.hasClass("gray")){var i=a.val(),j=b.val();if(!j||-1==parseInt(j))return void b.addClass("err");var k=c.val();if(k&&-1!=parseInt(k)){var l=$.trim(d.val());if(!l||!/^\S{1,12}$/.test(l))return void d.addClass("err");var m=$.trim(e.val());if(!m||!/^1\d{10}$/.test(m))return void e.addClass("err");var n=f.children("span.selector_item.selected").attr("purchase");submitForm(i,j,k,l,m,n,function(a){closeOverlayApplyForm(),a.content&&parseInt(a.content)>0?showOverlayVerifyCode(a.content,m):showOverlayRight(m)},function(a){closeOverlayApplyForm(),showOverlayErr(a)})}}})}function updateOverlayAreaBrandSeries(a,b){function c(){e.removeClass("err"),f.attr("disabled","true").empty();var b=e.val();return-1==parseInt(b)?void e.addClass("err"):void getBrand(b,function(b){for(var c=0;c<b.length;c++){var e=b[c],g=$("<option>").val(e.id).text(e.display_name);f.append(g),(-1==a&&0==c||a==e.id)&&g.attr("selected","selected")}f.removeAttr("disabled"),d()},function(){})}function d(){f.removeClass("err"),g.attr("disabled","true").empty();var a=f.val();if(-1==parseInt(a))return void f.addClass("err");var c=$("#overlay_brand").get(0).selectedIndex,d=areas[e.val()][c];if(d){var h=d.prize||"";h?$("#overlay_gift").html("<span>赠</span>"+h).show():$("#overlay_gift").hide()}else $("#overlay_gift").hide();getSeries(a,function(a){for(var c=0;c<a.length;c++){var d=a[c],e=$("<option>").val(d.series_id).text(d.name);g.append(e),(-1==b&&0==c||b==d.series_id)&&e.attr("selected","selected")}g.removeAttr("disabled")},function(){});var i=$("#overlay_btn");getFinished(e.val(),a)?i.addClass("gray").text("报名已结束"):i.removeClass("gray").text("报名参团")}a||(a=-1),b||(b=-1);var e=$("#overlay_area"),f=$("#overlay_brand"),g=$("#overlay_series");e.change(c),f.change(d),c()}function initOverlayApplyCode(){var a=$("#overlay_code_code");a.focusin(function(b){a.removeClass("err").removeClass("right")}),a.focusout(function(b){var c=$.trim(a.val());c&&/^\d{6}$/.test(c)?a.addClass("right"):a.addClass("err")}),$("#overlay_code_btn").on("click",function(b){var c=$("#overlay_code").attr("codeid"),d=$("#overlay_code").attr("mobile"),e=$.trim(a.val());return e&&/^\d{6}$/.test(e)?void $.ajax({url:"/aj_tuan/checkVerifyCode",data:{code:e,id:c},dataType:"json",type:"post",success:function(a){a&&0==a.code?(closeOverlayVerifyCode(),showOverlayRight(d)):(closeOverlayVerifyCode(),showOverlayErr(a))},error:function(a){closeOverlayVerifyCode(),showOverlayErr()}}):void a.addClass("err")})}function initOverlayApplyRight(){$("#overlay_right_btn").on("click",function(a){closeOverlayRight(),showOverlayApplyForm(current_brand_id,current_series_id)})}function initOverlayApplyErr(){$("#overlay_err_btn").on("click",function(a){closeOverlayErr(),showOverlayApplyForm(current_brand_id,current_series_id)})}function showOverlayApplyForm(a,b){a||(a=-1),b||(b=-1),$("#overlay_form").show(),updateOverlayAreaBrandSeries(a,b)}function closeOverlayApplyForm(){$("#overlay_form").hide()}function showOverlayVerifyCode(a,b){$("#overlay_code").show().attr("codeid",a).attr("mobile",b)}function closeOverlayVerifyCode(){$("#overlay_code").hide().removeAttr("codeid").removeAttr("mobile")}function showOverlayRight(a){$("#overlay_right").show().attr("mobile",a)}function closeOverlayRight(){$("#overlay_right").hide().removeAttr("mobile")}function showOverlayErr(a){var b="系统忙，请稍后再试";a&&a.desc&&(b=a.desc),$("#overlay_err .apply_wrap p b").text(b),$("#overlay_err").show()}function closeOverlayErr(){$("#overlay_err").hide()}function submitForm(a,b,c,d,e,f,g,h){submitting||(submitting=!0,$.ajax({url:"/aj_tuan/add",data:{id:a,br:b,se:c,user:d,mobile:e,purchase:f,channel:3},dataType:"json",type:"post",success:function(a){a&&0==a.code?g(a):h(a),submitting=!1},error:function(a){h(a),submitting=!1}}))}function getBrand(a,b,c){return areas[a]?void b(areas[a]):void $.ajax({url:"/aj_tuan/getLogic",data:{area_id:a},dataType:"json",type:"post",success:function(c){if(c&&0==c.code&&c.content.length){var d=c.content;areas[a]=d,b(d)}},error:function(a){c()}})}function getSeries(a,b,c){return brands[a]?void b(brands[a]):void $.ajax({url:"/aj_tuan/getSeries",data:{bid:a},dataType:"json",type:"post",success:function(c){if(c&&0==c.code&&c.content.length){var d=c.content;brands[a]=d,b(d)}},error:function(a){c()}})}function getFinished(a,b){var c=areas[a];if(!c)return!0;for(var d=(new Date).getTime(),e=0;e<c.length;e++){var f=c[e];if(f.id==b){var g=f.endtime,h=new Date(g).getTime();isNaN(h)&&(h=new Date(g.replace(/-/g,"/")).getTime());var i=!1;return d>h&&(i=!0),i}}return!0}function getEndTime(a,b){var c=areas[a];if(!c)return 0;for(var d=0;d<c.length;d++){var e=c[d];if(e.id==b)return e.endtime}return 0}$(document).ready(onDOMReady);var submitting=!1;