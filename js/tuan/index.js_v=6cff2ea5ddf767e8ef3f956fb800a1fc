function onDOMReady(){initBrandItemUsers(),initBrandItemApplyBtn(),initRightApplyForm(),initRightApplyHotSeries(),initBottomApplyForm(),initOverlayApplyForm(),initOverlayApplyCode(),initOverlayApplyRight(),initOverlayApplyErr(),initTuanOnlineSidebar(),initPopArea(),initPopEmpty()}function initBrandSeriesLink(){function a(a){var b=$(this);if(!b.hasClass("selected")){if(!$(".fake_brand_series_link_wrap").length){var c=$(".brand_series_link_wrap"),d=c.width(),e=c.height(),f=c.css("margin"),g=$('<div class="fake_brand_series_link_wrap" style="position:relative;width:'+d+"px;height:"+e+"px;margin:"+f+'"></div>');c.before(g).css({position:"absolute",top:"0px",left:"0px"}).addClass("hover")}$(".brand_link_wrap a.brand_link_item").removeClass("selected"),b.addClass("selected");for(var h=b.position().top,i=b,j=b.index();j<$(".brand_link_wrap a.brand_link_item").length;j++){var k=$(".brand_link_wrap a.brand_link_item").eq(j);if(k.position().top>h)break;i=k}for(var l=b.attr("brandid"),m=brands[l],n=[],j=0;j<m.length;j++){var o=m[j];n.push('<a class="series_link_item" href="'+o.url+'">'+o.name+"</a>")}$(".series_link_wrap").remove(),i.after($('<div class="series_link_wrap">'+n.join("")+"</div>"))}}function b(){$(".brand_link_wrap a.brand_link_item").removeClass("selected"),$(".series_link_wrap").remove(),$(".fake_brand_series_link_wrap").remove(),$(".brand_series_link_wrap").css({position:"relative",top:"0px",left:"0px"}).removeClass("hover")}$(".brand_link_wrap a.brand_link_item").bind("mouseenter",a),$(".brand_series_link_wrap").bind("mouseleave",b)}function initBrandItemUsers(){$(".brand_item").each(function(a,b){function c(){var a=parseInt(d.css("top"));if(e.css("top","108px"),d.animate({top:a-108+"px"},"slow"),Math.abs(a)>=g-108){e.animate({top:"0px"},"slow");var b=d;d=e,e=b}setTimeout(c,3e3)}b=$(b);var d=b.find(".brand_user_ul"),e=b.find(".brand_user_swap"),f=d.children("li").length;if(4>f)return!0;e.html(d.html());var g=36*d.children("li").length;setTimeout(c,3e3)})}function initBrandItemApplyBtn(){$(".brand_item .brand_btn").on("click",function(a){var b=$(this);if(!b.hasClass("gray")){var b=$(this),c=b.attr("brandid");showOverlayApplyForm(c,-1)}})}function initRightApplyForm(){function a(){c.removeClass("err"),d.attr("disabled","true").empty();var a=c.val();return-1==parseInt(a)?void c.addClass("err"):void getBrand(a,function(a){for(var c=0;c<a.length;c++){var e=a[c],f=$("<option>").val(e.id).text(e.display_name);d.append(f)}d.removeAttr("disabled"),b()},function(){})}function b(){d.removeClass("err"),e.attr("disabled","true").empty();var a=d.val();if(-1==parseInt(a))return void d.addClass("err");getSeries(a,function(a){for(var b=0;b<a.length;b++){var c=a[b],d=$("<option>").val(c.series_id).text(c.name);e.append(d)}e.removeAttr("disabled")},function(){});var b=$("#right_btn");getFinished(c.val(),a)?b.addClass("gray").text("报名已结束"):b.removeClass("gray").text("报名参团")}var c=$("#right_area"),d=$("#right_brand"),e=$("#right_series");c.change(a),d.change(b),a();var f=$("#right_name");f.focusin(function(a){f.removeClass("err").removeClass("right")}),f.focusout(function(a){var b=$.trim(f.val());b&&/^\S{1,12}$/.test(b)?f.addClass("right"):f.addClass("err")});var g=$("#right_mobile");g.focusin(function(a){g.removeClass("err").removeClass("right")}),g.focusout(function(a){var b=$.trim(g.val());b&&/^1\d{10}$/.test(b)?g.addClass("right"):g.addClass("err")}),$("#right_purchase span.selector_item").on("click",function(a){var b=$(this);b.hasClass("selected")||($("#right_purchase span.selector_item").removeClass("selected"),b.addClass("selected"))}),$("#right_btn").on("click",function(a){var b=$(this);if(!b.hasClass("gray")){var h=c.val(),i=d.val();if(!i||-1==parseInt(i))return void d.addClass("err");var j=e.val();if(!j||-1==parseInt(j))return void e.addClass("err");var k=$.trim(f.val());if(!k||!/^\S{1,12}$/.test(k))return void f.addClass("err");var l=$.trim(g.val());if(!l||!/^1\d{10}$/.test(l))return void g.addClass("err");var m=$("#right_purchase span.selector_item.selected").attr("purchase");submitForm(h,i,j,k,l,m,function(a){a.content&&parseInt(a.content)>0?showOverlayVerifyCode(a.content,l):showOverlayRight(l)},function(a){showOverlayErr(a)})}})}function initRightApplyHotSeries(){$("#right_hot_series p.hot_series").on("click",function(a){var b=$(this);showOverlayApplyForm(b.attr("brandid"),b.attr("seriesid"))})}function initBottomApplyForm(){function a(){c.removeClass("err"),d.attr("disabled","true").empty();var a=c.val();return-1==parseInt(a)?void c.addClass("err"):void getBrand(a,function(a){for(var c=0;c<a.length;c++){var e=a[c],f=$("<option>").val(e.id).text(e.display_name);d.append(f)}d.removeAttr("disabled"),b()},function(){})}function b(){d.removeClass("err"),e.empty();var a=d.val();if(-1==parseInt(a))return void d.addClass("err");var b=$("#bottom_brand").get(0).selectedIndex,f=areas[c.val()][b];if(f){var g=f.prize||"";g?$("#bottom_gift").html("<span>赠</span>"+g).show():$("#bottom_gift").hide()}else $("#bottom_gift").hide();getSeries(a,function(a){for(var b=0;b<a.length;b++){var c=a[b];e.append($('<span class="selector_item'+(0==b?" selected":"")+'" seriesid='+c.series_id+">"+c.name+"</span>"))}e.children("span.selector_item").on("click",function(a){var b=$(this);b.hasClass("selected")||(e.children("span.selector_item").removeClass("selected"),b.addClass("selected"))})},function(){});var h=$("#bottom_btn");getFinished(c.val(),a)?(h.addClass("gray").text("报名已结束"),$("#bottom_dtime_nodtime").text("报名已结束"),window.mcClockStore[$("#bottom_dtime_flipclock").attr("mc-clock-idx")]&&clearTimeout(window.mcClockStore[$("#bottom_dtime_flipclock").attr("mc-clock-idx")].OPTIONS.timer),$("#bottom_dtime_flipclock").empty().hide()):(h.removeClass("gray").text("报名参团"),$("#bottom_dtime_nodtime").text("报名倒计时"),$("#bottom_dtime_flipclock").show(),new mcClock({element:$("#bottom_dtime_flipclock"),endTime:new Date(getEndTime(c.val(),a).replace(/-/g,"/")),nowTime_Server:new Date}).startTime())}var c=$("#bottom_area"),d=$("#bottom_brand"),e=$("#bottom_series");c.change(a),d.change(b),a();var f=$("#bottom_name");f.focusin(function(a){f.removeClass("err").removeClass("right")}),f.focusout(function(a){var b=$.trim(f.val());b&&/^\S{1,12}$/.test(b)?f.addClass("right"):f.addClass("err")});var g=$("#bottom_mobile");g.focusin(function(a){g.removeClass("err").removeClass("right")}),g.focusout(function(a){var b=$.trim(g.val());b&&/^1\d{10}$/.test(b)?g.addClass("right"):g.addClass("err")});var h=$("#bottom_purchase");h.children("span.selector_item").on("click",function(a){var b=$(this);b.hasClass("selected")||(h.children("span.selector_item").removeClass("selected"),b.addClass("selected"))}),$("#bottom_btn").on("click",function(a){var b=$(this);if(!b.hasClass("gray")){var i=c.val(),j=d.val();if(!j||-1==parseInt(j))return void d.addClass("err");var k=e.children("span.selector_item.selected").attr("seriesid");if(k&&-1!=parseInt(k)){var l=$.trim(f.val());if(!l||!/^\S{1,12}$/.test(l))return void f.addClass("err");var m=$.trim(g.val());if(!m||!/^1\d{10}$/.test(m))return void g.addClass("err");var n=h.children("span.selector_item.selected").attr("purchase");submitForm(i,j,k,l,m,n,function(a){a.content&&parseInt(a.content)>0?showOverlayVerifyCode(a.content,m):showOverlayRight(m)},function(a){showOverlayErr(a)})}}})}function initOverlayApplyForm(){$("#overlay_form_close").on("click",function(a){closeOverlayApplyForm()});var a=$("#overlay_area"),b=$("#overlay_brand"),c=$("#overlay_series"),d=$("#overlay_name");d.focusin(function(a){d.removeClass("err").removeClass("right")}),d.focusout(function(a){var b=$.trim(d.val());b&&/^\S{1,12}$/.test(b)?d.addClass("right"):d.addClass("err")});var e=$("#overlay_mobile");e.focusin(function(a){e.removeClass("err").removeClass("right")}),e.focusout(function(a){var b=$.trim(e.val());b&&/^1\d{10}$/.test(b)?e.addClass("right"):e.addClass("err")});var f=$("#overlay_purchase");f.children("span.selector_item").on("click",function(a){var b=$(this);b.hasClass("selected")||(f.children("span.selector_item").removeClass("selected"),b.addClass("selected"))}),$("#overlay_btn").on("click",function(g){var h=$(this);if(!h.hasClass("gray")){var i=a.val(),j=b.val();if(!j||-1==parseInt(j))return void b.addClass("err");var k=c.children("span.selector_item.selected").attr("seriesid");if(k&&-1!=parseInt(k)){var l=$.trim(d.val());if(!l||!/^\S{1,12}$/.test(l))return void d.addClass("err");var m=$.trim(e.val());if(!m||!/^1\d{10}$/.test(m))return void e.addClass("err");var n=f.children("span.selector_item.selected").attr("purchase");submitForm(i,j,k,l,m,n,function(a){closeOverlayApplyForm(),a.content&&parseInt(a.content)>0?showOverlayVerifyCode(a.content,m):showOverlayRight(m)},function(a){closeOverlayApplyForm(),showOverlayErr(a)})}}})}function updateOverlayAreaBrandSeries(a,b){function c(){e.removeClass("err"),f.attr("disabled","true").empty();var b=e.val();return-1==parseInt(b)?void e.addClass("err"):void getBrand(b,function(b){for(var c=0;c<b.length;c++){var e=b[c],g=$("<option>").val(e.id).text(e.display_name);f.append(g),(-1==a&&0==c||a==e.id)&&g.attr("selected","selected")}f.removeAttr("disabled"),d()},function(){})}function d(){f.removeClass("err"),g.empty();var a=f.val();if(-1==parseInt(a))return void f.addClass("err");var c=$("#overlay_brand").get(0).selectedIndex,d=areas[e.val()][c];if(d){var h=d.prize||"";h?$("#overlay_gift").html("<span>赠</span>"+h).show():$("#overlay_gift").hide()}else $("#overlay_gift").hide();getSeries(a,function(a){for(var c=0;c<a.length;c++){var d=a[c];g.append($('<span class="selector_item'+(-1==b&&0==c||b==d.series_id?" selected":"")+'" seriesid='+d.series_id+">"+d.name+"</span>"))}g.children("span.selector_item").on("click",function(a){var b=$(this);b.hasClass("selected")||(g.children("span.selector_item").removeClass("selected"),b.addClass("selected"))})},function(){});var i=$("#overlay_btn");getFinished(e.val(),a)?(i.addClass("gray").text("报名已结束"),$("#overlay_dtime_nodtime").text("报名已结束"),window.mcClockStore[$("#overlay_dtime_flipclock").attr("mc-clock-idx")]&&clearTimeout(window.mcClockStore[$("#overlay_dtime_flipclock").attr("mc-clock-idx")].OPTIONS.timer),$("#overlay_dtime_flipclock").empty().hide()):(i.removeClass("gray").text("报名参团"),$("#overlay_dtime_nodtime").text("报名倒计时"),$("#overlay_dtime_flipclock").show(),new mcClock({element:$("#overlay_dtime_flipclock"),endTime:new Date(getEndTime(e.val(),a).replace(/-/g,"/")),nowTime_Server:new Date}).startTime())}a||(a=-1),b||(b=-1);var e=$("#overlay_area"),f=$("#overlay_brand"),g=$("#overlay_series");e.change(c),f.change(d),c()}function initOverlayApplyCode(){$("#overlay_code_close").on("click",refreshPage);var a=$("#overlay_code_code");a.focusin(function(b){a.removeClass("err").removeClass("right")}),a.focusout(function(b){var c=$.trim(a.val());c&&/^\d{6}$/.test(c)?a.addClass("right"):a.addClass("err")}),$("#overlay_code_btn").on("click",function(b){var c=$("#overlay_code").attr("codeid"),d=$("#overlay_code").attr("mobile"),e=$.trim(a.val());return e&&/^\d{6}$/.test(e)?void $.ajax({url:"/aj_tuan/checkVerifyCode",data:{code:e,id:c},dataType:"json",type:"post",success:function(a){a&&0==a.code?(closeOverlayVerifyCode(),showOverlayRight(d)):(closeOverlayVerifyCode(),showOverlayErr(a))},error:function(a){closeOverlayVerifyCode(),showOverlayErr()}}):void a.addClass("err")})}function initOverlayApplyRight(){$("#overlay_right_btn").on("click",refreshPage),$("#overlay_right_close").on("click",refreshPage)}function initOverlayApplyErr(){$("#overlay_err_btn").on("click",closeOverlayErr),$("#overlay_err_close").on("click",closeOverlayErr)}function showOverlayApplyForm(a,b){showMasklayer(!0),a||(a=-1),b||(b=-1),$("#overlay_form").show(),updateOverlayAreaBrandSeries(a,b)}function closeOverlayApplyForm(){showMasklayer(!1),$("#overlay_form").hide()}function showOverlayVerifyCode(a,b){showMasklayer(!0),$("#overlay_code").show().attr("codeid",a).attr("mobile",b)}function closeOverlayVerifyCode(){showMasklayer(!1),$("#overlay_code").hide().removeAttr("codeid").removeAttr("mobile")}function showOverlayRight(a){showMasklayer(!0);var b='<iframe id="overlay_right_iframe_success" src="/'+epath_area.area_path+'/tuan/success/" width="0" height="0" scrolling="no" frameborder="0"></iframe>';$("#overlay_right").show().attr("mobile",a).append($(b))}function closeOverlayRight(){showMasklayer(!1),$("#overlay_right_iframe_success").remove(),$("#overlay_right").hide().removeAttr("mobile")}function showOverlayErr(a){showMasklayer(!0);var b="系统忙，请稍后再试";a&&a.desc&&(b=a.desc),$("#overlay_err .apply_wrap p b").text(b),$("#overlay_err").show()}function closeOverlayErr(){showMasklayer(!1),$("#overlay_err").hide()}function submitForm(a,b,c,d,e,f,g,h){submitting||(submitting=!0,$.ajax({url:"/aj_tuan/add",data:{id:a,br:b,se:c,user:d,mobile:e,purchase:f,channel:1},dataType:"json",type:"post",success:function(a){a&&0==a.code?g(a):h(a),sendStat("result","is_tuan_result","mobile="+e),submitting=!1},error:function(a){h(a),submitting=!1}}),sendStat("click","is_tuan_apply","mobile="+e))}function getBrand(a,b,c){return areas[a]?void b(areas[a]):void $.ajax({url:"/aj_tuan/getLogic",data:{area_id:a},dataType:"json",type:"post",success:function(c){if(c&&0==c.code&&c.content.length){var d=c.content;areas[a]=d,b(d)}},error:function(a){c()}})}function getSeries(a,b,c){return brands[a]?void b(brands[a]):void $.ajax({url:"/aj_tuan/getSeries",data:{bid:a},dataType:"json",type:"post",success:function(c){if(c&&0==c.code&&c.content.length){var d=c.content;brands[a]=d,b(d)}},error:function(a){c()}})}function getFinished(a,b){var c=areas[a];if(!c)return!0;for(var d=(new Date).getTime(),e=0;e<c.length;e++){var f=c[e];if(f.id==b){var g=f.endtime,h=new Date(g).getTime();isNaN(h)&&(h=new Date(g.replace(/-/g,"/")).getTime());var i=!1;return d>h&&(i=!0),i}}return!0}function getEndTime(a,b){var c=areas[a];if(!c)return 0;for(var d=0;d<c.length;d++){var e=c[d];if(e.id==b)return e.endtime}return 0}function showMasklayer(a){a?(masklayer=$("body").masklayer(),masklayer.masklayer("show")):masklayer&&masklayer.masklayer("destroy")}function refreshPage(){var a=window.location.href;a.match(/tip=1/)?window.location.href=a.replace(/tip=1/,"tip=0"):window.location.reload(!0)}function initTuanOnlineSidebar(){function a(){d=window.setTimeout(b,18e4)}function b(){$(".tuan_online_sidebar .content_wrap").show()}function c(){$(".tuan_online_sidebar .content_wrap").hide(),a()}var d=0;$(".tuan_online_sidebar .trigger_wrap .tuan_online_sidebar_trigger_item.online").mouseenter(function(){window.clearTimeout(d),b()}),$(".tuan_online_sidebar").mouseleave(function(){c()}),$(".tuan_online_sidebar .content_wrap .close").on("click",function(a){c()}),a()}function initPopArea(){var a=$(".pop_area_wrap");0!=a.length&&$("#pop_area_close").on("click",function(b){a.remove()})}function initPopEmpty(){function a(){window.clearInterval(d),url=b.attr("url"),window.location.href=url}var b=$(".pop_empty_wrap");if(0!=b.length){var c=3,d=window.setInterval(function(){0>=c&&a(),$(".pop_empty_dtime span").text(c),c--},1e3);$(".pop_empty_content_wrap .btn").on("click",a)}}$(document).ready(onDOMReady);var submitting=!1;